{% comment %}

This is the Django template used by test-taskqueue.py
{% endcomment %}
<!doctype html>
<html>
    <head>
        {% if status == "starting" or status == "building" or status == "importing" %}
            <meta http-equiv="refresh" content="{{ refresh_interval }}">
        {% endif %}
        
        <title>{{ app_title }}</title>
        <link rel="stylesheet" type="text/css" href="static/tasks_backup.css"></link>
        
        <script language="javascript" type="text/javascript" src="static/datetimepicker.js">
            //Date Time Picker script- by TengYong Ng of http://www.rainforestnet.com
            //Script featured on JavaScript Kit (http://www.javascriptkit.com)
            //For this script, visit http://www.javascriptkit.com 
        </script>
        
        <script type="text/javascript">

            function disableDisplayHtmlButton() {
                document.getElementById("display-tasks-button").value = "Building display page (this may take many minutes) ...";
                document.getElementById("display-tasks-button").innerHTML = "Building display page (this may take many minutes) ...";
                document.getElementById("display-tasks-button").disabled = true;
                // Also disable retrieve button, since clicking it after display button 
                // has been clicked, results in display process being interrupted. 
                // Display button stays disabled, user get selected download file, 
                // but user never sees the display page.
                document.getElementById("retrieve-tasks-button").disabled = true;
            }
            
            function changeCompletedSuboptions() {
                if (document.getElementById("display_completed_tasks").checked) 
                {
                    document.getElementById("dim_completed_tasks").checked = true; // Default
                    document.getElementById("dim_completed_tasks").disabled = false;
                    document.getElementById("display_completed_date_field").checked = true;
                    document.getElementById("display_completed_date_field").disabled = false;
                } else {
                    document.getElementById("dim_completed_tasks").checked = false;
                    document.getElementById("dim_completed_tasks").disabled = true;
                    document.getElementById("display_completed_date_field").checked = false;
                    document.getElementById("display_completed_date_field").disabled = true;
                }
            }
            
            function changeCompletedOptions() {
                if (document.getElementById("due_selection_any_due").checked ||
                    document.getElementById("due_selection_due_now").checked ||
                    document.getElementById("due_selection_overdue").checked)
                {
                    e = false;
                } else {
                    e = true;
                }
                document.getElementById("display_completed_tasks").checked = e;
                changeCompletedSuboptions();
//                document.getElementById("dim_completed_tasks").checked = e;
//                document.getElementById("display_completed_date_field").checked = e;
        }
            
            function changeDisplayCompleted() {
                if (document.getElementById("dim_completed_tasks").checked ||
                    document.getElementById("display_completed_date_field").checked) 
                {
                    document.getElementById("display_completed_tasks").checked = true;
                }
            }
            
            function setDateFields(day, month, year) {
                document.getElementById("due_year").value = year;
                document.getElementById("due_month").value = month + 1; // JS Months are 0-11
                document.getElementById("due_day").value = day;
                yearStr = "0000" + year.toString();
                yearStr = yearStr.substring(yearStr.length - 4);
                monthStr = "00" + (month + 1).toString();
                monthStr = monthStr.substring(monthStr.length -2);
                dayStr = "00" + day.toString();
                dayStr = dayStr.substring(dayStr.length - 2);
                document.getElementById("due_date").innerHTML = yearStr + "-" + monthStr + "-" + dayStr;
            }
            
            function setCurrentDueDate() {
                // Set the current date, which is used when displaying current due tasks.
                // We take the date from the browser, so that the due date is today in the user's current timezone is used
                var today = new Date();
                setDateFields(today.getDate(), today.getMonth(), today.getFullYear());
            }
        
        </script>
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-30118203-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>
    </head>

<body onload="changeCompletedSuboptions(); changeCompletedOptions(); changeDisplayCompleted(); setCurrentDueDate()" > 
    <div class="usertitle">
        Authorised user: {{ user_email }} <span class="logout-link">[ <a href="{{ logout_url }}">Log out</a> ]</span>
    </div>

    <h2>{{ app_title }}</h2>

    <noscript>
        <br />
        <h3>Javascript must be enabled for full application functionality</h3>
        <br />
    </noscript>
    
    {% if host_msg %}
        <div class="break">
            <h3>{{ host_msg }}</h3>
        </div>
    {% endif %}

    {% if msg %}
        <div class="break">
            <p>Msg = {{ msg }}</p>
		</div>
    {% endif %}
    
    {% if error_message %}
        <div class="take-note break">
        {{ error_message }}
        </div>
		<div class="break">
			Please report this error at <a href="http:/{{ url_issues_page }}">{{ url_issues_page }}</a>
		</div>
    {% endif %}
    
    {% if status == "no-record" %}
        <div class="break">
            No backup found for {{ user_email }}
            <br />
            Please click button to start a backup
        <form method="GET" action="{{ home_page_url }}">
            <button type="submit">Start backup</button>
        </form>
        </div>
    {% endif %}
    
    
    {% if status == "starting" or status == "building"  or status == "importing" %}
        <div class="break">
            This page will auto-refresh every {{ refresh_interval }} seconds to indicate how many tasks have been retrieved so far.
		</div>
    {% endif %}
    
    {% if status == "completed" %}
        <div class="break">
            Backup completed. Retrieved {{ progress }} tasks.
            {% if include_completed %}
                <br/>
                <span class="comment">Includes completed tasks</span>
            {% else %}
                <br/>
                <span class="comment">Excludes completed tasks</span>
            {% endif %}
            {% if include_hidden %}
                <br/>
                <span class="comment">Includes hidden tasks</span>
            {% endif %}
            {% if include_deleted %}
                <br/>
                <span class="comment">Includes deleted tasks</span>
            {% endif %}
		</div>
    {% else %}
        {% if status == "import_completed" %}
            <div class="import-completed-message">
                <div class="take-note-larger">
                    Import completed.
                </div>
                <div class="break">
                    Imported {{ progress }} tasks.
                </div>
            </div>
            <form action="/" method="get">
                <button type="submit" class="big-button" value="Return to home page">Return to home page</button>
            </form>
        {% else %}
            <div class="break">
                Status = {{ status }}
            </div>
            <div class="break">
                Progress = {{ progress }}
            </div>
        {% endif %}
    {% endif %}
    
    
    {% if status == "completed" %}
        <div class="break">
            Note that this backup is a snapshot of tasks as at {{ job_start_timestamp }} UTC 
            and will not reflect changes made after that time. 
            You will need to rerun <a href="{{ home_page_url }}" >{{ app_title }}</a>
            to create a new backup.
        </div>
        
        <div class="break">
        </div>
        
        <!-- Choose format to return backup data -->
        <form method="POST" action="{{ results_url }}" >
        
			<fieldset>
				<legend>Export all tasks</legend>
				<table class="format-selection">
					<!--<col width="20%">
					<col width="80%">-->
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="import_export" checked="checked" /> Import/Export CSV<br />
						</td>
						<td>
							CSV formatted for importing back into {{ app_title }} (e.g. as a backup, or when transferring tasks to another Google account).
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="outlook" /> Outlook CSV<br />
						</td>
						<td>
							CSV file suitable for importing into Outlook.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="ics" /> iCal ICS<br />
						</td>
						<td>
							iCal .ICS file suitable for importing into many calendar applications.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="raw" /> Raw CSV<br />
						</td>
						<td>
							CSV file containing almost all available properties for each task. See the <a href="static/info.html">information page</a> for details.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="raw1" /> Raw CSV, formatted dates<br />
						</td>
						<td>
							Same as Raw CSV, but with date/timestamps formatted suitable for reading by Excel.
						</td>
					</tr>
                    <tr>
                        <td class="format-name">
                            <input type="radio" name="format" value="py" /> Python<br />
                        </td>
                        <td>
                            Python data structure. Contains all the properties stored by Google for each task. See the <a href="static/info.html">information page</a> for details.
                        </td>
                    </tr>
					<tr>
						<td class="format-name">
							<input type="radio" name="format" value="RTM" /> RTM email<br />
						</td>
						<td>
							Email tasks in Remember The Milk format. 
                            <span class="take-note-smaller">(<a href="#notes">Notes</a> 1, 2 &amp; 3)</span>
						</td>
					</tr>
					</table>
					<br />

				<button type="submit" id="retrieve-tasks-button" class="big-button" value="Retrieve tasks data">Retrieve tasks data</button>
			</fieldset>
        </form>
        
        <div class="break">
        </div>
        

        <form method="POST" action="{{ results_url }}" onsubmit="disableDisplayHtmlButton();" >
        
            <input type="hidden" name="format" value="html_raw" />
            <input type="hidden" name="job_start_timestamp" value="{{ job_start_timestamp }}" />
            
            <!-- These values are set by setDateFields(), which is originally called by setCurrentDueDate() on page load.
                 setDateFields() is also called when the user clicks on a date the date picker form.
            -->
            <input type="hidden" id="due_year" name="due_year" value="0001" />
            <input type="hidden" id="due_month" name="due_month" value="1" />
            <input type="hidden" id="due_day" name="due_day" value="1" />
            
            
			<fieldset>
				<legend>
                    Display all tasks as a single web page, suitable for printing <span class="take-note-smaller"> (<a href="#notes">Note</a> 4)</span>
                </legend>
                <div class="format-selection">
                    <div class="left-column">
                        <div class="selection-column-header">
                            Filter by due date <span id="due_date" class="due_date" onclick="javascript:NewCal('due_date')" >0001-01-01</span>&nbsp;<button type="button" onclick="javascript:NewCal('due_date')" >Choose date <img src="static/cal.gif" width="16" height="16" border="0" alt="Set due date filter"></button>&nbsp;or&nbsp;<button type="button" onclick="setCurrentDueDate()" >Use today</button>
	  		
                            </div>
                        <noscript>
                            <br />
                            <span class="take-note">Javascript must be enabled to determine current date, and to enable date to be set</span>
                            </noscript>
                        </input>
                        <ul class="format-selection">
                            <li>
                                <input id="due_selection_all" type="radio" name="due_selection" value="all" 
                                       onchange="changeCompletedOptions();" checked="yes" />
                                <label for="due_selection_all">All tasks</label>
                            </li>
                            <li>
                                <input id="due_selection_any_due" type="radio" name="due_selection" value="any_due"
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Any tasks with a due date (incl future due)</label>
                            </li>
                            <li>
                                <input id="due_selection_due_now" type="radio" name="due_selection" value="due_now"
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Tasks due on or before selected date</label>
                            </li>
                            <li>
                                <input id="due_selection_overdue" type="radio" name="due_selection" value="overdue" 
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Overdue only(due before selected data)</label>
                            </li>
                        </ul>
                        <div class="selection-column-header">Other task filters</div>
                        <ul class="format-selection">
                            <li>
                                <input type="checkbox" name="display_invalid_tasks" value="True" >
                                    &nbsp;Display invalid/corrupted tasks? <span class="take-note-smaller">(<a href="#notes">Note</a> 7)</span>
                                </input>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="right-column">
                        <div class="selection-column-header">Display options</div>
                        <ul class="format-selection">
                            {% if include_completed %}
                            <li>
                                <input type="checkbox" id="display_completed_tasks" name="display_completed_tasks" value="True" 
                                       checked="checked"  onchange="changeCompletedSuboptions();">
                                    &nbsp;Display completed tasks? <span class="take-note-smaller"> (<a href="#notes">Note</a> 5)</span>
                                </input>
                            </li>
                            <li>
                                <ul class="format-selection sub-list">
                                <li>
                                    <input type="checkbox" id="dim_completed_tasks" name="dim_completed_tasks" value="True" 
                                           onchange="changeDisplayCompleted();" checked="checked" >
                                        &nbsp;Dim completed tasks? <span class="take-note-smaller"> (<a href="#notes">Note</a> 5)</span>
                                    </input>
                                </li>
                                <li>
                                    <input type="checkbox" id="display_completed_date_field" name="display_completed_date_field" value="True"  
                                           onchange="changeDisplayCompleted();" checked="checked" >
                                        &nbsp;Display completed date field?
                                    </input>
                                </li>
                                </ul>
                            </li>
                            {% endif %}
                            <li>
                                <input type="checkbox" name="display_due_date_field" value="True" checked="checked" >
                                    &nbsp;Display due date field?
                                </input>
                            </li>
                            <li>
                                <input type="checkbox" name="display_updated_date_field" value="True" >
                                    &nbsp;Display updated date field?
                                </input>
                            </li>
                        </ul>
                    </div>
                </div>
				<br />
                
                    <div class="take-note-para end-columns">
                    {% if progress >= large_list_html_warning_limit %}
                        <span class="take-note">CAUTION: You have a very large number of tasks. Attempting to display the tasks page (especially if using method 1) may result in the server running out of memory and/or your browser timing out.
                        </span>
                        <br />
                        You may wish to export your tasks first, before attempting to display the tasks page.
                    {% endif %}
                    </div>
				<button id="display-tasks-button" type="submit" class="big-button" >Display tasks page</button>
			</fieldset>
        </form>
        <div class="break">
        </div>
        
        <div class="heading">
            <a name="notes">Notes</a>
        </div>
        <table  class="format-selection">
            <tr>
                <td class="note-heading-smaller">
                    Note 1 - 
                </td>
                <td>
                    Attempting to email large tasklists will fail due to App Engine quota limits.
                </td>
            </tr>
            <tr>
                <td class="note-heading-smaller">
                    Note 2 - 
                </td>
                <td>
                    It appears that RTM will not import more than 50 tasks.
                </td>
            </tr>
            <tr>
                <td class="note-heading-smaller">
                    Note 3 - 
                </td>
                <td>
                    Any header text must be removed before forwarding the received email to your RTM import email address. The first line in the email must be a task.
                </td>
            </tr>
            <tr>
                <td class="note-heading-smaller">
                    Note 4 - 
                </td>
                <td>
                    The resultant web page will contain all the tasks in all the task lists. 
                    There is no pretty formatting, so a page break may occur in the middle of a task.
                    <br/>
                    Note that the resultant printout can be MANY pages (especially when tasks have notes). 
                    973 tasks in 7 tasklists resulted in 141 pages.
                </td>
            </tr>
            <tr>
                <td class="note-heading-smaller">
                    Note 5 - 
                </td>
                <td>
                    If checked, completed tasks are displayed using a dimmed grey font. Hidden and deleted tasks are always dim.
                </td>
            </tr>
            <tr>
                <td class="note-heading-smaller">
                    Note 7 - 
                </td>
                <td>
                    If checked, the application tries to identify and label potentially invalid tasks.
                    <br />
                    Refer to <a href="static/info.html#notes">note 4 on the information page</a> for more details.
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    Refer to the <a href="static/info.html">information page</a> for more information on the exported properties.
                </td>
            </tr>
        </table>
    {% endif %}


	<div class="project-footer">
        <div class="break">
            Version {{ app_version }} ({{ upload_timestamp }})
        </div>
        
		<div class="break">
			Questions or comments? Go to <a href="http://{{ url_discussion_group }}">{{ url_discussion_group }}</a>
			or email <a href="mailto:{{ email_discussion_group }}">{{ email_discussion_group }}</a>
		</div>
		<div class="break">
			Please report bugs or suggest improvements at <a href="http:/{{ url_issues_page }}">{{ url_issues_page }}</a>
		</div>
		<div class="break">
			Source code for this project is at <a href="http://{{ url_source_code }}">{{ url_source_code }}</a>
		</div>
	</div>

</body>
</html>
